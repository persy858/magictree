<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .language-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .language-switcher button {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .language-switcher button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-switcher button.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .tree-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
        }

        .tree-visual {
            font-size: 8em;
            margin: 20px 0;
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .cooldown-timer {
            font-size: 1.2em;
            color: #ffd700;
            margin: 10px 0;
        }

        .message {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .connected-address {
            font-family: monospace;
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fruit-icon {
            font-size: 3em;
            display: inline-block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .error-message {
            background: rgba(255, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid rgba(255, 0, 0, 0.5);
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-top: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switcher">
                <button onclick="switchLanguage('zh')" id="langZh" class="active">中文</button>
                <button onclick="switchLanguage('en')" id="langEn">English</button>
            </div>
            <h1 data-i18n="title">🌳 神树DApp</h1>
            <p class="subtitle" data-i18n="subtitle">培育你的神奇树木，收获丰硕果实</p>
        </header>

        <div class="wallet-section">
            <div id="walletConnect">
                <button class="btn" onclick="connectWallet()" data-i18n="connectWallet">连接钱包</button>
                <div id="networkError" class="error-message" style="display: none;"></div>
            </div>
            <div id="walletConnected" style="display: none;">
                <p data-i18n="walletConnected">✅ 钱包已连接</p>
                <p class="connected-address" id="userAddress"></p>
                <!-- <div class="debug-info" id="debugInfo"></div> -->
            </div>
        </div>

        <div id="mintSection" style="display: none;">
            <div class="tree-container">
                <h2 data-i18n="plantTree">🌱 种植你的神树</h2>
                <p style="margin: 20px 0;" data-i18n="mintCost">铸造一颗神树需要 0.01 ETH</p>
                <button class="btn" onclick="mintTree()" data-i18n="mintButton">种植神树 (0.01 ETH)</button>
                <div id="mintMessage" class="message" style="display: none;"></div>
            </div>
        </div>

        <div id="treeSection" style="display: none;">
            <div class="tree-container">
                <div class="tree-visual">🌳</div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label" data-i18n="fertilizeCount">施肥次数</div>
                        <div class="stat-value" id="fertilizeCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" data-i18n="fruitCount">果实数量</div>
                        <div class="stat-value"><span class="fruit-icon">🍎</span> <span id="fruitCount">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" data-i18n="totalPoints">总积分</div>
                        <div class="stat-value" id="pointsCount">0</div>
                    </div>
                </div>

                <div id="cooldownDisplay" class="cooldown-timer" style="display: none;">
                    <span data-i18n="cooldownPrefix">⏱️ 冷却中:</span> <span id="cooldownTime">0</span><span data-i18n="cooldownSuffix">秒</span>
                </div>

                <div class="actions">
                    <button class="btn" id="fertilizeBtn" onclick="fertilizeTree()" data-i18n="fertilizeButton">
                        🌿 施肥 (需要Gas)
                    </button>
                    <button class="btn btn-secondary" id="harvestBtn" onclick="harvestFruit()" disabled data-i18n="harvestButton">
                        🍎 采摘果实
                    </button>
                </div>

                <div id="actionMessage" class="message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============= 多语言配置 =============
        const translations = {
            zh: {
                title: "🌳 神树DApp",
                subtitle: "培育你的神奇树木，收获丰硕果实",
                connectWallet: "连接钱包",
                walletConnected: "✅ 钱包已连接",
                plantTree: "🌱 种植你的神树",
                mintCost: "铸造一颗神树需要 0.01 ETH",
                mintButton: "种植神树 (0.01 ETH)",
                fertilizeCount: "施肥次数",
                fruitCount: "果实数量",
                totalPoints: "总积分",
                cooldownPrefix: "⏱️ 冷却中:",
                cooldownSuffix: "秒",
                fertilizeButton: "🌿 施肥 (需要Gas)",
                harvestButton: "🍎 采摘果实",
                
                // 错误和提示消息
                installMetaMask: "请安装MetaMask钱包!",
                switchToSepolia: "请切换到 Sepolia 测试网！当前网络:",
                setContractAddress: "请先在代码中设置合约地址 CONTRACT_ADDRESS！",
                invalidAddress: "合约地址格式错误！请检查 CONTRACT_ADDRESS 是否为有效的以太坊地址",
                connectFailed: "连接钱包失败:",
                getTreeInfoFailed: "获取神树信息失败:",
                
                // 交易消息
                minting: "正在铸造神树...",
                txSubmitted: "交易已提交，等待确认...",
                mintSuccess: "🎉 神树铸造成功!",
                mintFailed: "❌ 铸造失败:",
                fertilizing: "正在施肥...",
                fertilizeSuccess: "✅ 施肥成功！",
                fertilizeWithFruit: "🎉 施肥成功！神树结出了果实！",
                fertilizeFailed: "❌ 施肥失败:",
                harvesting: "正在采摘果实...",
                harvestSuccess: "🎉 采摘成功！获得",
                harvestSuccessSuffix: "积分！",
                harvestFailed: "❌ 采摘失败:",
                
                // 调试信息
                network: "网络:",
                address: "地址:",
                contractAddr: "合约地址:"
            },
            en: {
                title: "🌳 Magic Tree DApp",
                subtitle: "Grow your magical tree and harvest bountiful fruits",
                connectWallet: "Connect Wallet",
                walletConnected: "✅ Wallet Connected",
                plantTree: "🌱 Plant Your Magic Tree",
                mintCost: "Minting a magic tree costs 0.01 ETH",
                mintButton: "Plant Tree (0.01 ETH)",
                fertilizeCount: "Fertilize Count",
                fruitCount: "Fruit Count",
                totalPoints: "Total Points",
                cooldownPrefix: "⏱️ Cooldown:",
                cooldownSuffix: "s",
                fertilizeButton: "🌿 Fertilize (Gas Required)",
                harvestButton: "🍎 Harvest Fruit",
                
                // Error and info messages
                installMetaMask: "Please install MetaMask wallet!",
                switchToSepolia: "Please switch to Sepolia testnet! Current network:",
                setContractAddress: "Please set CONTRACT_ADDRESS in the code first!",
                invalidAddress: "Invalid contract address format! Please check if CONTRACT_ADDRESS is a valid Ethereum address",
                connectFailed: "Failed to connect wallet:",
                getTreeInfoFailed: "Failed to get tree info:",
                
                // Transaction messages
                minting: "Minting magic tree...",
                txSubmitted: "Transaction submitted, waiting for confirmation...",
                mintSuccess: "🎉 Magic tree minted successfully!",
                mintFailed: "❌ Minting failed:",
                fertilizing: "Fertilizing...",
                fertilizeSuccess: "✅ Fertilized successfully!",
                fertilizeWithFruit: "🎉 Fertilized successfully! The tree bore fruit!",
                fertilizeFailed: "❌ Fertilization failed:",
                harvesting: "Harvesting fruit...",
                harvestSuccess: "🎉 Harvest successful! Gained",
                harvestSuccessSuffix: "points!",
                harvestFailed: "❌ Harvest failed:",
                
                // Debug info
                network: "Network:",
                address: "Address:",
                contractAddr: "Contract:"
            }
        };

        let currentLang = localStorage.getItem('language') || 'zh';

        // 切换语言
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            // 更新按钮状态
            document.getElementById('langZh').classList.toggle('active', lang === 'zh');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            // 更新所有文本
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            console.log('Language switched to:', lang);
        }

        // 获取翻译文本
        function t(key) {
            return translations[currentLang][key] || key;
        }

        // 页面加载时应用语言
        document.addEventListener('DOMContentLoaded', () => {
            switchLanguage(currentLang);
        });

        // ============= 合约配置 =============
        // 合约配置 - 部署后需要替换这个地址
        // 重要：地址必须是完整的 42 字符的十六进制格式，例如：
        // const CONTRACT_ADDRESS = "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1";
        const CONTRACT_ADDRESS = "0xFa96769A8A67E0272e25e51c8cF910793Ce931Cf";
        
        const CONTRACT_ABI = [
            "function mintTree() external payable",
            "function fertilize() external",
            "function harvestFruit() external",
            "function getTreeInfo(address user) external view returns (bool exists, uint256 fertilizeCount, uint256 lastActionTime, uint256 fruits, uint256 points, uint256 cooldownRemaining)",
            "event TreeMinted(address indexed owner, uint256 timestamp)",
            "event TreeFertilized(address indexed owner, uint256 count, uint256 timestamp)",
            "event FruitHarvested(address indexed owner, uint256 fruitCount, uint256 timestamp)",
            "event FruitDecomposed(address indexed owner, uint256 points, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let cooldownInterval;

        // 连接钱包
        async function connectWallet() {
            try {
                console.log("开始连接钱包...");
                
                if (!window.ethereum) {
                    showError("networkError", t('installMetaMask'));
                    return;
                }

                // 请求连接钱包
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                console.log("钱包已连接:", userAddress);

                // 检查网络
                const network = await provider.getNetwork();
                console.log("当前网络:", network.chainId, network.name);
                
                // const debugInfo = document.getElementById("debugInfo");
                // debugInfo.innerHTML = `
                //     ${t('network')} ${network.name} (Chain ID: ${network.chainId})<br>
                //     ${t('address')} ${userAddress}<br>
                //     ${t('contractAddr')} ${CONTRACT_ADDRESS}
                // `;

                if (network.chainId !== 11155111n) {
                    showError("networkError", t('switchToSepolia') + " " + network.name);
                    
                    // 尝试切换网络
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia chainId in hex
                        });
                        location.reload();
                    } catch (switchError) {
                        console.error("切换网络失败:", switchError);
                    }
                    return;
                }

                // 检查合约地址是否设置
                if (!CONTRACT_ADDRESS || CONTRACT_ADDRESS === "YOUR_CONTRACT_ADDRESS_HERE") {
                    showError("networkError", t('setContractAddress'));
                    return;
                }

                // 验证合约地址格式
                if (!ethers.isAddress(CONTRACT_ADDRESS)) {
                    showError("networkError", t('invalidAddress'));
                    console.error("无效的合约地址:", CONTRACT_ADDRESS);
                    return;
                }

                // 创建合约实例 - 使用 getAddress 确保地址格式正确
                const contractAddress = ethers.getAddress(CONTRACT_ADDRESS);
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);
                console.log("合约实例已创建，地址:", contractAddress);

                // 隐藏错误信息
                document.getElementById("networkError").style.display = "none";
                document.getElementById("walletConnect").style.display = "none";
                document.getElementById("walletConnected").style.display = "block";
                document.getElementById("userAddress").textContent = userAddress;

                await checkTreeStatus();
            } catch (error) {
                console.error("连接钱包错误:", error);
                showError("networkError", "❌ " + t('connectFailed') + " " + error.message);
            }
        }

        // 检查神树状态
        async function checkTreeStatus() {
            try {
                console.log("检查神树状态...");
                const treeInfo = await contract.getTreeInfo(userAddress);
                console.log("神树信息:", treeInfo);
                
                if (treeInfo.exists) {
                    document.getElementById("mintSection").style.display = "none";
                    document.getElementById("treeSection").style.display = "block";
                    updateTreeDisplay(treeInfo);
                } else {
                    document.getElementById("mintSection").style.display = "block";
                    document.getElementById("treeSection").style.display = "none";
                }
            } catch (error) {
                console.error("检查神树状态错误:", error);
                showMessage("mintMessage", "❌ " + t('getTreeInfoFailed') + " " + error.message, "error");
            }
        }

        // 更新神树显示
        function updateTreeDisplay(treeInfo) {
            document.getElementById("fertilizeCount").textContent = treeInfo.fertilizeCount.toString();
            document.getElementById("fruitCount").textContent = treeInfo.fruits.toString();
            document.getElementById("pointsCount").textContent = treeInfo.points.toString();

            const harvestBtn = document.getElementById("harvestBtn");
            harvestBtn.disabled = treeInfo.fruits === 0n;

            // 更新冷却时间
            if (treeInfo.cooldownRemaining > 0n) {
                startCooldownTimer(Number(treeInfo.cooldownRemaining));
            } else {
                document.getElementById("fertilizeBtn").disabled = false;
                document.getElementById("cooldownDisplay").style.display = "none";
            }
        }

        // 冷却计时器
        function startCooldownTimer(seconds) {
            document.getElementById("fertilizeBtn").disabled = true;
            document.getElementById("cooldownDisplay").style.display = "block";
            
            if (cooldownInterval) clearInterval(cooldownInterval);
            
            let remaining = seconds;
            document.getElementById("cooldownTime").textContent = remaining;
            
            cooldownInterval = setInterval(() => {
                remaining--;
                document.getElementById("cooldownTime").textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(cooldownInterval);
                    document.getElementById("fertilizeBtn").disabled = false;
                    document.getElementById("cooldownDisplay").style.display = "none";
                }
            }, 1000);
        }

        // 铸造神树
        async function mintTree() {
            try {
                showMessage("mintMessage", t('minting'), "info");
                const tx = await contract.mintTree({ value: ethers.parseEther("0.01") });
                showMessage("mintMessage", t('txSubmitted'), "info");
                await tx.wait();
                showMessage("mintMessage", t('mintSuccess'), "success");
                setTimeout(() => checkTreeStatus(), 2000);
            } catch (error) {
                console.error("铸造神树错误:", error);
                showMessage("mintMessage", "❌ " + t('mintFailed') + " " + error.message, "error");
            }
        }

        // 施肥
        async function fertilizeTree() {
            try {
                showMessage("actionMessage", t('fertilizing'), "info");
                const tx = await contract.fertilize();
                showMessage("actionMessage", t('txSubmitted'), "info");
                const receipt = await tx.wait();
                
                // 检查是否产生了果实
                const fruitEvent = receipt.logs.find(log => {
                    try {
                        return contract.interface.parseLog(log).name === "FruitHarvested";
                    } catch { return false; }
                });
                
                if (fruitEvent) {
                    showMessage("actionMessage", t('fertilizeWithFruit'), "success");
                } else {
                    showMessage("actionMessage", t('fertilizeSuccess'), "success");
                }
                
                setTimeout(() => checkTreeStatus(), 2000);
            } catch (error) {
                console.error("施肥错误:", error);
                showMessage("actionMessage", "❌ " + t('fertilizeFailed') + " " + error.message, "error");
            }
        }

        // 采摘果实
        async function harvestFruit() {
            try {
                showMessage("actionMessage", t('harvesting'), "info");
                const tx = await contract.harvestFruit();
                showMessage("actionMessage", t('txSubmitted'), "info");
                const receipt = await tx.wait();
                
                // 解析获得的积分
                const decomposeEvent = receipt.logs.find(log => {
                    try {
                        return contract.interface.parseLog(log).name === "FruitDecomposed";
                    } catch { return false; }
                });
                
                if (decomposeEvent) {
                    const parsedEvent = contract.interface.parseLog(decomposeEvent);
                    const points = parsedEvent.args.points;
                    showMessage("actionMessage", `${t('harvestSuccess')} ${points} ${t('harvestSuccessSuffix')}`, "success");
                }
                
                setTimeout(() => checkTreeStatus(), 2000);
            } catch (error) {
                console.error("采摘果实错误:", error);
                showMessage("actionMessage", "❌ " + t('harvestFailed') + " " + error.message, "error");
            }
        }

        // 显示消息
        function showMessage(elementId, message, type) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.style.display = "block";
            msgElement.style.background = type === "error" ? "rgba(255, 0, 0, 0.3)" : 
                                         type === "success" ? "rgba(0, 255, 0, 0.3)" : 
                                         "rgba(255, 255, 255, 0.2)";
        }

        // 显示错误
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = "block";
        }

        // 监听账户切换
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                console.log("账户已切换，重新加载页面");
                location.reload();
            });
            window.ethereum.on('chainChanged', () => {
                console.log("网络已切换，重新加载页面");
                location.reload();
            });
        }

        // 页面加载时检查是否已经连接
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                console.log("检测到已连接的钱包，自动连接...");
                await connectWallet();
            }
        });
    </script>
</body>
</html>