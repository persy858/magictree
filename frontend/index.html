<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .language-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .language-switcher button {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .language-switcher button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-switcher button.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .tree-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
        }

        .tree-visual {
            font-size: 8em;
            margin: 20px 0;
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .cooldown-timer {
            font-size: 1.2em;
            color: #ffd700;
            margin: 10px 0;
        }

        .message {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .connected-address {
            font-family: monospace;
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fruit-icon {
            font-size: 3em;
            display: inline-block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .error-message {
            background: rgba(255, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid rgba(255, 0, 0, 0.5);
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-top: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switcher">
                <button onclick="switchLanguage('zh')" id="langZh" class="active">ä¸­æ–‡</button>
                <button onclick="switchLanguage('en')" id="langEn">English</button>
            </div>
            <h1 data-i18n="title">ğŸŒ³ ç¥æ ‘DApp</h1>
            <p class="subtitle" data-i18n="subtitle">åŸ¹è‚²ä½ çš„ç¥å¥‡æ ‘æœ¨ï¼Œæ”¶è·ä¸°ç¡•æœå®</p>
        </header>

        <div class="wallet-section">
            <div id="walletConnect">
                <button class="btn" onclick="connectWallet()" data-i18n="connectWallet">è¿æ¥é’±åŒ…</button>
                <div id="networkError" class="error-message" style="display: none;"></div>
            </div>
            <div id="walletConnected" style="display: none;">
                <p data-i18n="walletConnected">âœ… é’±åŒ…å·²è¿æ¥</p>
                <p class="connected-address" id="userAddress"></p>
                <!-- <div class="debug-info" id="debugInfo"></div> -->
            </div>
        </div>

        <div id="mintSection" style="display: none;">
            <div class="tree-container">
                <h2 data-i18n="plantTree">ğŸŒ± ç§æ¤ä½ çš„ç¥æ ‘</h2>
                <p style="margin: 20px 0;" data-i18n="mintCost">é“¸é€ ä¸€é¢—ç¥æ ‘éœ€è¦ 0.01 ETH</p>
                <button class="btn" onclick="mintTree()" data-i18n="mintButton">ç§æ¤ç¥æ ‘ (0.01 ETH)</button>
                <div id="mintMessage" class="message" style="display: none;"></div>
            </div>
        </div>

        <div id="treeSection" style="display: none;">
            <div class="tree-container">
                <div class="tree-visual">ğŸŒ³</div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label" data-i18n="fertilizeCount">æ–½è‚¥æ¬¡æ•°</div>
                        <div class="stat-value" id="fertilizeCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" data-i18n="fruitCount">æœå®æ•°é‡</div>
                        <div class="stat-value"><span class="fruit-icon">ğŸ</span> <span id="fruitCount">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" data-i18n="totalPoints">æ€»ç§¯åˆ†</div>
                        <div class="stat-value" id="pointsCount">0</div>
                    </div>
                </div>

                <div id="cooldownDisplay" class="cooldown-timer" style="display: none;">
                    <span data-i18n="cooldownPrefix">â±ï¸ å†·å´ä¸­:</span> <span id="cooldownTime">0</span><span data-i18n="cooldownSuffix">ç§’</span>
                </div>

                <div class="actions">
                    <button class="btn" id="fertilizeBtn" onclick="fertilizeTree()" data-i18n="fertilizeButton">
                        ğŸŒ¿ æ–½è‚¥ (éœ€è¦Gas)
                    </button>
                    <button class="btn btn-secondary" id="harvestBtn" onclick="harvestFruit()" disabled data-i18n="harvestButton">
                        ğŸ é‡‡æ‘˜æœå®
                    </button>
                </div>

                <div id="actionMessage" class="message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============= å¤šè¯­è¨€é…ç½® =============
        const translations = {
            zh: {
                title: "ğŸŒ³ ç¥æ ‘DApp",
                subtitle: "åŸ¹è‚²ä½ çš„ç¥å¥‡æ ‘æœ¨ï¼Œæ”¶è·ä¸°ç¡•æœå®",
                connectWallet: "è¿æ¥é’±åŒ…",
                walletConnected: "âœ… é’±åŒ…å·²è¿æ¥",
                plantTree: "ğŸŒ± ç§æ¤ä½ çš„ç¥æ ‘",
                mintCost: "é“¸é€ ä¸€é¢—ç¥æ ‘éœ€è¦ 0.01 ETH",
                mintButton: "ç§æ¤ç¥æ ‘ (0.01 ETH)",
                fertilizeCount: "æ–½è‚¥æ¬¡æ•°",
                fruitCount: "æœå®æ•°é‡",
                totalPoints: "æ€»ç§¯åˆ†",
                cooldownPrefix: "â±ï¸ å†·å´ä¸­:",
                cooldownSuffix: "ç§’",
                fertilizeButton: "ğŸŒ¿ æ–½è‚¥ (éœ€è¦Gas)",
                harvestButton: "ğŸ é‡‡æ‘˜æœå®",
                
                // é”™è¯¯å’Œæç¤ºæ¶ˆæ¯
                installMetaMask: "è¯·å®‰è£…MetaMaské’±åŒ…!",
                switchToSepolia: "è¯·åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘ï¼å½“å‰ç½‘ç»œ:",
                setContractAddress: "è¯·å…ˆåœ¨ä»£ç ä¸­è®¾ç½®åˆçº¦åœ°å€ CONTRACT_ADDRESSï¼",
                invalidAddress: "åˆçº¦åœ°å€æ ¼å¼é”™è¯¯ï¼è¯·æ£€æŸ¥ CONTRACT_ADDRESS æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€",
                connectFailed: "è¿æ¥é’±åŒ…å¤±è´¥:",
                getTreeInfoFailed: "è·å–ç¥æ ‘ä¿¡æ¯å¤±è´¥:",
                
                // äº¤æ˜“æ¶ˆæ¯
                minting: "æ­£åœ¨é“¸é€ ç¥æ ‘...",
                txSubmitted: "äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...",
                mintSuccess: "ğŸ‰ ç¥æ ‘é“¸é€ æˆåŠŸ!",
                mintFailed: "âŒ é“¸é€ å¤±è´¥:",
                fertilizing: "æ­£åœ¨æ–½è‚¥...",
                fertilizeSuccess: "âœ… æ–½è‚¥æˆåŠŸï¼",
                fertilizeWithFruit: "ğŸ‰ æ–½è‚¥æˆåŠŸï¼ç¥æ ‘ç»“å‡ºäº†æœå®ï¼",
                fertilizeFailed: "âŒ æ–½è‚¥å¤±è´¥:",
                harvesting: "æ­£åœ¨é‡‡æ‘˜æœå®...",
                harvestSuccess: "ğŸ‰ é‡‡æ‘˜æˆåŠŸï¼è·å¾—",
                harvestSuccessSuffix: "ç§¯åˆ†ï¼",
                harvestFailed: "âŒ é‡‡æ‘˜å¤±è´¥:",
                
                // è°ƒè¯•ä¿¡æ¯
                network: "ç½‘ç»œ:",
                address: "åœ°å€:",
                contractAddr: "åˆçº¦åœ°å€:"
            },
            en: {
                title: "ğŸŒ³ Magic Tree DApp",
                subtitle: "Grow your magical tree and harvest bountiful fruits",
                connectWallet: "Connect Wallet",
                walletConnected: "âœ… Wallet Connected",
                plantTree: "ğŸŒ± Plant Your Magic Tree",
                mintCost: "Minting a magic tree costs 0.01 ETH",
                mintButton: "Plant Tree (0.01 ETH)",
                fertilizeCount: "Fertilize Count",
                fruitCount: "Fruit Count",
                totalPoints: "Total Points",
                cooldownPrefix: "â±ï¸ Cooldown:",
                cooldownSuffix: "s",
                fertilizeButton: "ğŸŒ¿ Fertilize (Gas Required)",
                harvestButton: "ğŸ Harvest Fruit",
                
                // Error and info messages
                installMetaMask: "Please install MetaMask wallet!",
                switchToSepolia: "Please switch to Sepolia testnet! Current network:",
                setContractAddress: "Please set CONTRACT_ADDRESS in the code first!",
                invalidAddress: "Invalid contract address format! Please check if CONTRACT_ADDRESS is a valid Ethereum address",
                connectFailed: "Failed to connect wallet:",
                getTreeInfoFailed: "Failed to get tree info:",
                
                // Transaction messages
                minting: "Minting magic tree...",
                txSubmitted: "Transaction submitted, waiting for confirmation...",
                mintSuccess: "ğŸ‰ Magic tree minted successfully!",
                mintFailed: "âŒ Minting failed:",
                fertilizing: "Fertilizing...",
                fertilizeSuccess: "âœ… Fertilized successfully!",
                fertilizeWithFruit: "ğŸ‰ Fertilized successfully! The tree bore fruit!",
                fertilizeFailed: "âŒ Fertilization failed:",
                harvesting: "Harvesting fruit...",
                harvestSuccess: "ğŸ‰ Harvest successful! Gained",
                harvestSuccessSuffix: "points!",
                harvestFailed: "âŒ Harvest failed:",
                
                // Debug info
                network: "Network:",
                address: "Address:",
                contractAddr: "Contract:"
            }
        };

        let currentLang = localStorage.getItem('language') || 'zh';

        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('langZh').classList.toggle('active', lang === 'zh');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            console.log('Language switched to:', lang);
        }

        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key) {
            return translations[currentLang][key] || key;
        }

        // é¡µé¢åŠ è½½æ—¶åº”ç”¨è¯­è¨€
        document.addEventListener('DOMContentLoaded', () => {
            switchLanguage(currentLang);
        });

        // ============= åˆçº¦é…ç½® =============
        // åˆçº¦é…ç½® - éƒ¨ç½²åéœ€è¦æ›¿æ¢è¿™ä¸ªåœ°å€
        // é‡è¦ï¼šåœ°å€å¿…é¡»æ˜¯å®Œæ•´çš„ 42 å­—ç¬¦çš„åå…­è¿›åˆ¶æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
        // const CONTRACT_ADDRESS = "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1";
        const CONTRACT_ADDRESS = "0xFa96769A8A67E0272e25e51c8cF910793Ce931Cf";
        
        const CONTRACT_ABI = [
            "function mintTree() external payable",
            "function fertilize() external",
            "function harvestFruit() external",
            "function getTreeInfo(address user) external view returns (bool exists, uint256 fertilizeCount, uint256 lastActionTime, uint256 fruits, uint256 points, uint256 cooldownRemaining)",
            "event TreeMinted(address indexed owner, uint256 timestamp)",
            "event TreeFertilized(address indexed owner, uint256 count, uint256 timestamp)",
            "event FruitHarvested(address indexed owner, uint256 fruitCount, uint256 timestamp)",
            "event FruitDecomposed(address indexed owner, uint256 points, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let cooldownInterval;

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                console.log("å¼€å§‹è¿æ¥é’±åŒ…...");
                
                if (!window.ethereum) {
                    showError("networkError", t('installMetaMask'));
                    return;
                }

                // è¯·æ±‚è¿æ¥é’±åŒ…
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                console.log("é’±åŒ…å·²è¿æ¥:", userAddress);

                // æ£€æŸ¥ç½‘ç»œ
                const network = await provider.getNetwork();
                console.log("å½“å‰ç½‘ç»œ:", network.chainId, network.name);
                
                // const debugInfo = document.getElementById("debugInfo");
                // debugInfo.innerHTML = `
                //     ${t('network')} ${network.name} (Chain ID: ${network.chainId})<br>
                //     ${t('address')} ${userAddress}<br>
                //     ${t('contractAddr')} ${CONTRACT_ADDRESS}
                // `;

                if (network.chainId !== 11155111n) {
                    showError("networkError", t('switchToSepolia') + " " + network.name);
                    
                    // å°è¯•åˆ‡æ¢ç½‘ç»œ
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia chainId in hex
                        });
                        location.reload();
                    } catch (switchError) {
                        console.error("åˆ‡æ¢ç½‘ç»œå¤±è´¥:", switchError);
                    }
                    return;
                }

                // æ£€æŸ¥åˆçº¦åœ°å€æ˜¯å¦è®¾ç½®
                if (!CONTRACT_ADDRESS || CONTRACT_ADDRESS === "YOUR_CONTRACT_ADDRESS_HERE") {
                    showError("networkError", t('setContractAddress'));
                    return;
                }

                // éªŒè¯åˆçº¦åœ°å€æ ¼å¼
                if (!ethers.isAddress(CONTRACT_ADDRESS)) {
                    showError("networkError", t('invalidAddress'));
                    console.error("æ— æ•ˆçš„åˆçº¦åœ°å€:", CONTRACT_ADDRESS);
                    return;
                }

                // åˆ›å»ºåˆçº¦å®ä¾‹ - ä½¿ç”¨ getAddress ç¡®ä¿åœ°å€æ ¼å¼æ­£ç¡®
                const contractAddress = ethers.getAddress(CONTRACT_ADDRESS);
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);
                console.log("åˆçº¦å®ä¾‹å·²åˆ›å»ºï¼Œåœ°å€:", contractAddress);

                // éšè—é”™è¯¯ä¿¡æ¯
                document.getElementById("networkError").style.display = "none";
                document.getElementById("walletConnect").style.display = "none";
                document.getElementById("walletConnected").style.display = "block";
                document.getElementById("userAddress").textContent = userAddress;

                await checkTreeStatus();
            } catch (error) {
                console.error("è¿æ¥é’±åŒ…é”™è¯¯:", error);
                showError("networkError", "âŒ " + t('connectFailed') + " " + error.message);
            }
        }

        // æ£€æŸ¥ç¥æ ‘çŠ¶æ€
        async function checkTreeStatus() {
            try {
                console.log("æ£€æŸ¥ç¥æ ‘çŠ¶æ€...");
                const treeInfo = await contract.getTreeInfo(userAddress);
                console.log("ç¥æ ‘ä¿¡æ¯:", treeInfo);
                
                if (treeInfo.exists) {
                    document.getElementById("mintSection").style.display = "none";
                    document.getElementById("treeSection").style.display = "block";
                    updateTreeDisplay(treeInfo);
                } else {
                    document.getElementById("mintSection").style.display = "block";
                    document.getElementById("treeSection").style.display = "none";
                }
            } catch (error) {
                console.error("æ£€æŸ¥ç¥æ ‘çŠ¶æ€é”™è¯¯:", error);
                showMessage("mintMessage", "âŒ " + t('getTreeInfoFailed') + " " + error.message, "error");
            }
        }

        // æ›´æ–°ç¥æ ‘æ˜¾ç¤º
        function updateTreeDisplay(treeInfo) {
            document.getElementById("fertilizeCount").textContent = treeInfo.fertilizeCount.toString();
            document.getElementById("fruitCount").textContent = treeInfo.fruits.toString();
            document.getElementById("pointsCount").textContent = treeInfo.points.toString();

            const harvestBtn = document.getElementById("harvestBtn");
            harvestBtn.disabled = treeInfo.fruits === 0n;

            // æ›´æ–°å†·å´æ—¶é—´
            if (treeInfo.cooldownRemaining > 0n) {
                startCooldownTimer(Number(treeInfo.cooldownRemaining));
            } else {
                document.getElementById("fertilizeBtn").disabled = false;
                document.getElementById("cooldownDisplay").style.display = "none";
            }
        }

        // å†·å´è®¡æ—¶å™¨
        function startCooldownTimer(seconds) {
            document.getElementById("fertilizeBtn").disabled = true;
            document.getElementById("cooldownDisplay").style.display = "block";
            
            if (cooldownInterval) clearInterval(cooldownInterval);
            
            let remaining = seconds;
            document.getElementById("cooldownTime").textContent = remaining;
            
            cooldownInterval = setInterval(() => {
                remaining--;
                document.getElementById("cooldownTime").textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(cooldownInterval);
                    document.getElementById("fertilizeBtn").disabled = false;
                    document.getElementById("cooldownDisplay").style.display = "none";
                }
            }, 1000);
        }

        // é“¸é€ ç¥æ ‘
        async function mintTree() {
            try {
                showMessage("mintMessage", t('minting'), "info");
                const tx = await contract.mintTree({ value: ethers.parseEther("0.01") });
                showMessage("mintMessage", t('txSubmitted'), "info");
                await tx.wait();
                showMessage("mintMessage", t('mintSuccess'), "success");
                setTimeout(() => checkTreeStatus(), 2000);
            } catch (error) {
                console.error("é“¸é€ ç¥æ ‘é”™è¯¯:", error);
                showMessage("mintMessage", "âŒ " + t('mintFailed') + " " + error.message, "error");
            }
        }

        // æ–½è‚¥
        async function fertilizeTree() {
            try {
                showMessage("actionMessage", t('fertilizing'), "info");
                const tx = await contract.fertilize();
                showMessage("actionMessage", t('txSubmitted'), "info");
                const receipt = await tx.wait();
                
                // æ£€æŸ¥æ˜¯å¦äº§ç”Ÿäº†æœå®
                const fruitEvent = receipt.logs.find(log => {
                    try {
                        return contract.interface.parseLog(log).name === "FruitHarvested";
                    } catch { return false; }
                });
                
                if (fruitEvent) {
                    showMessage("actionMessage", t('fertilizeWithFruit'), "success");
                } else {
                    showMessage("actionMessage", t('fertilizeSuccess'), "success");
                }
                
                setTimeout(() => checkTreeStatus(), 2000);
            } catch (error) {
                console.error("æ–½è‚¥é”™è¯¯:", error);
                showMessage("actionMessage", "âŒ " + t('fertilizeFailed') + " " + error.message, "error");
            }
        }

        // é‡‡æ‘˜æœå®
        async function harvestFruit() {
            try {
                showMessage("actionMessage", t('harvesting'), "info");
                const tx = await contract.harvestFruit();
                showMessage("actionMessage", t('txSubmitted'), "info");
                const receipt = await tx.wait();
                
                // è§£æè·å¾—çš„ç§¯åˆ†
                const decomposeEvent = receipt.logs.find(log => {
                    try {
                        return contract.interface.parseLog(log).name === "FruitDecomposed";
                    } catch { return false; }
                });
                
                if (decomposeEvent) {
                    const parsedEvent = contract.interface.parseLog(decomposeEvent);
                    const points = parsedEvent.args.points;
                    showMessage("actionMessage", `${t('harvestSuccess')} ${points} ${t('harvestSuccessSuffix')}`, "success");
                }
                
                setTimeout(() => checkTreeStatus(), 2000);
            } catch (error) {
                console.error("é‡‡æ‘˜æœå®é”™è¯¯:", error);
                showMessage("actionMessage", "âŒ " + t('harvestFailed') + " " + error.message, "error");
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.style.display = "block";
            msgElement.style.background = type === "error" ? "rgba(255, 0, 0, 0.3)" : 
                                         type === "success" ? "rgba(0, 255, 0, 0.3)" : 
                                         "rgba(255, 255, 255, 0.2)";
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = "block";
        }

        // ç›‘å¬è´¦æˆ·åˆ‡æ¢
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                console.log("è´¦æˆ·å·²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½é¡µé¢");
                location.reload();
            });
            window.ethereum.on('chainChanged', () => {
                console.log("ç½‘ç»œå·²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½é¡µé¢");
                location.reload();
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç»è¿æ¥
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                console.log("æ£€æµ‹åˆ°å·²è¿æ¥çš„é’±åŒ…ï¼Œè‡ªåŠ¨è¿æ¥...");
                await connectWallet();
            }
        });
    </script>
</body>
</html>